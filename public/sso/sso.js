var validationUrl,validate,accountId,tokenId,apiKey,flagLogin="__c2FmYXJpVmVyaWZpY2F0aW9uVG9rZW4UfLflagLogin",cookieFlagLogin="__c2FmYXJpVmVyaWZpY2F0aW9uVG9rZW4UfLflagLogin",countLogin="__c2FmYXJpVmVyaWZpY2F0aW9uVG9rZW4UfLcountLogin",safariCookie="__c2FmYXJpVmVyaWZpY2F0aW9uVG9rZW4UfL";function onIdentification(o){domain="*",postMessageToListeners(o,domain)}function onLogout(){domain="*";postMessageToListeners({action:"sso.onlogout"},domain)}function onLoad(){domain="*";postMessageToListeners({action:"sso.onload"},domain)}function isSafariBrowser(){var o=navigator.userAgent.indexOf("Safari")>-1;return navigator.userAgent.indexOf("Chrome")>-1&&o&&(o=!1),o}function getCookieByName(o){var e;if(2===(e=("; "+document.cookie).split("; "+o+"=")).length)return e.pop().split(";").shift()}function deleteCookieByName(o){document.cookie=o+"=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;"}function setPersistentCookie(o,e){var a,t=new Date;t.setFullYear(t.getFullYear()+5),a=o+"="+e+"; path=/; expires="+t.toUTCString(),document.cookie=a}function postMessageToListeners(o,e){window.attachEvent?window.parent.postMessage(JSON.stringify(o),e):window.parent.postMessage(o,e)}function doLogout(){isSafariBrowser(),deleteCookieByName(safariCookie),deleteCookieByName(cookieFlagLogin),deleteCookieByName(countLogin),onLogout()}function doLogin(o){isSafariBrowser()?(setPersistentCookie(safariCookie,o),setPersistentCookie(cookieFlagLogin,"1")):(setPersistentCookie(safariCookie,o),localStorage.setItem(flagLogin,"1"))}function localStorageHandler(o){var e;(e=(isSafariBrowser(),getCookieByName(safariCookie)))?validateJWT(e):onLogout()}function localStorageHandlerIE8(o){setTimeout(function(){var o=localStorage.getItem(tokenId);o?validateJWT(o):onLogout()},1)}function listener(event){var data=event.data;if(event.data&&!event.data.action&&(data=eval("("+event.data+")")),data.hasOwnProperty("action")){var action=data.action;"logout"===action?doLogout():"login"===action&&data.hasOwnProperty("jwt")&&doLogin(data.jwt)}}function validateJWT(o){var e;validate&&validationUrl?null!=(e=isSafariBrowser()?getCookieByName(countLogin):localStorage.getItem(countLogin))&&1!=e&&2!=e||validateJWTRemote(o):parseJWTLocal(o)}function validateJWTRemote(o){jwt=new JWT(o),new RestClient(validationUrl,accountId,apiKey).validateJWT(o,function(e){var a,t=e;"SUCCESS"===t.status?(t.token&&t.token!=o?doLogin(t.token):t.token=o,t.action="sso.onidentification",null==(a=isSafariBrowser()?getCookieByName(countLogin):localStorage.getItem(countLogin))?a=1:1===a?a=2:2===a&&(a=3),isSafariBrowser()?setPersistentCookie(countLogin,a):localStorage.setItem(countLogin,a),onIdentification(t)):(isSafariBrowser()?deleteCookieByName(safariCookie):localStorage.removeItem(tokenId),onLogout());onLoad()},function(o){log(LogLevels.DEBUG,o)})}function parseJWTLocal(o){try{var e=new JWT(o),a=e.payload();if(e.isExpired())throw"JWT expired";a.status="UNKNOWN",a.action="sso.onidentification",a.jwt=o,onIdentification(a)}catch(o){}onLoad()}function ready(){var o;(o=(isSafariBrowser(),getCookieByName(safariCookie)))?validateJWT(o):(isSafariBrowser()?getCookieByName(cookieFlagLogin):localStorage.getItem(flagLogin))?onLoad():onLogout()}function init(o){window.addEventListener?window.addEventListener("storage",localStorageHandler):document.attachEvent("onstorage",localStorageHandlerIE8),window.addEventListener?addEventListener("message",listener,!1):attachEvent("onmessage",listener),window.addEventListener?window.addEventListener("load",ready,!1):window.attachEvent&&window.attachEvent("onload",ready),validationUrl=o.validationUrl,validate=o.validate,accountId=o.accountId,tokenId=o.tokenId,apiKey=o.apiKey}
