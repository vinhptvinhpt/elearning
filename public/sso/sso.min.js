var validationUrl,validate,accountId,tokenId,apiKey,flagLogin="flagLogin",cookieFlagLogin="__c2FmYXJpVmVyaWZpY2F0aW9uVG9rZW4UfLflagLogin",safariCookie="__c2FmYXJpVmVyaWZpY2F0aW9uVG9rZW4UfL";function onIdentification(o){domain="*",postMessageToListeners(o,domain)}function onLogout(){domain="*";postMessageToListeners({action:"sso.onlogout"},domain)}function onLoad(){domain="*";postMessageToListeners({action:"sso.onload"},domain)}function isSafariBrowser(){var o=navigator.userAgent.indexOf("Safari")>-1;return navigator.userAgent.indexOf("Chrome")>-1&&o&&(o=!1),o}function getCookieByName(o){var e;if(2===(e=("; "+document.cookie).split("; "+o+"=")).length)return e.pop().split(";").shift()}function deleteCookieByName(o){document.cookie=o+"=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;"}function setPersistentCookie(o,e){var t,a=new Date;a.setFullYear(a.getFullYear()+5),t=o+"="+e+"; path=/; expires="+a.toUTCString(),document.cookie=t}function postMessageToListeners(o,e){window.attachEvent?window.parent.postMessage(JSON.stringify(o),e):window.parent.postMessage(o,e)}function doLogout(){isSafariBrowser()?(deleteCookieByName(safariCookie),deleteCookieByName(cookieFlagLogin)):(localStorage.removeItem(tokenId),localStorage.removeItem(flagLogin)),onLogout()}function doLogin(o){isSafariBrowser()?(setPersistentCookie(safariCookie,o),setPersistentCookie(cookieFlagLogin,"1")):(localStorage.setItem(tokenId,o),localStorage.setItem(flagLogin,"1"))}function localStorageHandler(o){var e;(e=isSafariBrowser()?window.localStorage.getItem(tokenId):localStorage.getItem(tokenId))?validateJWT(e):onLogout()}function localStorageHandlerIE8(o){setTimeout(function(){var o=localStorage.getItem(tokenId);o?validateJWT(o):onLogout()},1)}function listener(event){var data=event.data;if(event.data&&!event.data.action&&(data=eval("("+event.data+")")),data.hasOwnProperty("action")){var action=data.action;"logout"===action?doLogout():"login"===action&&data.hasOwnProperty("jwt")&&doLogin(data.jwt)}}function validateJWT(o){validate&&validationUrl?validateJWTRemote(o):parseJWTLocal(o)}function validateJWTRemote(o){jwt=new JWT(o),new RestClient(validationUrl,accountId,apiKey).validateJWT(o,function(e){var t=e;console.log("obj: "+JSON.stringify(t)),"SUCCESS"===t.status?(console.log("success jwt"),t.token&&t.token!=o?doLogin(t.token):t.token=o,t.action="sso.onidentification",onIdentification(t)):"FAIL"===t.status?(isSafariBrowser()?deleteCookieByName(safariCookie):localStorage.removeItem(tokenId),onLogout()):(isSafariBrowser()?deleteCookieByName(safariCookie):localStorage.removeItem(tokenId),onIdentification(t)),onLoad()},function(o){log(LogLevels.DEBUG,o)})}function parseJWTLocal(o){try{var e=new JWT(o),t=e.payload();if(e.isExpired())throw"JWT expired";t.status="UNKNOWN",t.action="sso.onidentification",t.jwt=o,onIdentification(t)}catch(o){localStorage.removeItem(tokenId)}onLoad()}function ready(){var o;(o=isSafariBrowser()?getCookieByName(safariCookie):localStorage.getItem(tokenId))?validateJWT(o):(isSafariBrowser()?getCookieByName(cookieFlagLogin):localStorage.getItem(flagLogin))?onLoad():onLogout()}function init(o){window.addEventListener?window.addEventListener("storage",localStorageHandler):document.attachEvent("onstorage",localStorageHandlerIE8),window.addEventListener?addEventListener("message",listener,!1):attachEvent("onmessage",listener),window.addEventListener?window.addEventListener("load",ready,!1):window.attachEvent&&window.attachEvent("onload",ready),validationUrl=o.validationUrl,validate=o.validate,accountId=o.accountId,tokenId=o.tokenId,apiKey=o.apiKey}